import React from 'react';
import { Router, Route, MemoryRouter } from 'react-router-dom';
import { render, fireEvent, screen, cleanup, waitFor, waitForElementToBeRemoved } from '@testing-library/react';
import axiosMock from 'axios';
import SearchPage, { parseRedditData } from './SearchPage';
import Theme from '../../styles/theme';
import App from '../../components/App/App';
import { createMemoryHistory } from 'history';
import '@testing-library/jest-dom/extend-expect';
import { DEFAULT_SUBREDDIT, DEFAULT_PATH } from '../../config';
import user from '@testing-library/user-event';
import SearchBar from './SearchBar/SearchBar';

jest.mock('axios');

afterEach(cleanup);

/* beforeEach(() => {
  app = render(
    <MemoryRouter>
      <Theme>
        <App />
      </Theme>
    </MemoryRouter>
  );
  container = app.container;
});
afterEach(() => {
  cleanup();
  app.remove();
  app = null;
}); */

const renderWithRouter = (component, path, page) => {
  const url = `/${path}/${page}`;
  return (
    render(
      <MemoryRouter initialEntries={[url]}>
        <Theme>
          <Route path={`/${path}/:subreddit`}>{component}</Route>
        </Theme>
      </MemoryRouter>,
    )
  );
};

test('loads and displays greeting', async () => {
  // Render the component
  const { getByTestId, findByTestId } = renderWithRouter(
    <SearchPage />, DEFAULT_PATH, DEFAULT_SUBREDDIT,
  );

  await waitFor(() => {
    expect(getByTestId('loading-spinner')).toBeInTheDocument();
  });

  await waitForElementToBeRemoved(getByTestId('loading-spinner')).then(() =>
    console.log('Element no longer in DOM'),
  );


  // const heatmap = await waitFor(() => findByTestId('heatmap'));
});

// The test below manually changes the subreddit and then
//    starts the search. It is proving to be difficult to work with as the page
//    automatically performs a search on its own, leading to two separate searches.

/* test('loads and displays greeting', async () => {
  // Render the component
  const { getByTestId, findByTestId } = renderWithRouter(<SearchPage />, DEFAULT_PATH, DEFAULT_SUBREDDIT);

  // Change and check the search input
  const searchInput = getByTestId('search-input');
  fireEvent.change(searchInput, { target: { value: 'learnprogramming' } });
  expect(searchInput.value).toBe('learnprogramming');

  // Click the search button
  const searchButton = getByTestId('search-button');
  fireEvent.click(searchButton);

  // Mock the API pull
  axiosMock.get.mockResolvedValueOnce({
    data: { greeting: 'hello there' },
  });

  // Check the spinner is showing
  const spinner = getByTestId('loading-spinner');
  expect(spinner).toBeInTheDocument();

  await waitForElementToBeRemoved(spinner).then(() =>
    console.log('Element no longer in DOM')
  )


  const heatmap = await waitFor(() => findByTestId('heatmap'));

  expect(heatmap).toHaveTextContent('All times are shown in your timezone');
  expect(axiosMock.get).toHaveBeenCalledTimes(1);
  expect(axiosMock.get).toHaveBeenCalledWith(url);
  expect(screen.getByRole('heading')).toHaveTextContent('hello there');
  expect(screen.getByRole('button')).toHaveAttribute('disabled');
});
 */
test('Search input value is set to default value', () => {
  const { getByTestId } = renderWithRouter(<SearchPage />, DEFAULT_PATH, DEFAULT_SUBREDDIT);
  const searchInput = getByTestId('search-input');
  expect(searchInput.value).toBe(DEFAULT_SUBREDDIT);
});
/* test('Spinner is shown when loading', () => {
  const { getByTestId } = renderWithRouter(<SearchPage />, DEFAULT_PATH, DEFAULT_SUBREDDIT);
  const searchButton = screen.getByTestId('search-button');
  user.click(searchButton);
  const spinner = getByTestId('loading-spinner');
  expect(spinner).toBeInTheDocument();
}); */

/* const renderWithRouter = (component, subreddit) => {}
  render(
    <MemoryRouter initialEntries={[`/search/${subreddit}`]}>
      <Theme>
        <Route path={`/search/${subreddit}`}>{component}</Route>
      </Theme>
    </MemoryRouter>,
  );
 */

/* const renderWithRouter = (component, path, page) => {
  const url = `/${path}/${page}`;
  return (
    render(
      <MemoryRouter initialEntries={[url]}>
        <Theme>
          <Route path={url}>{component}</Route>
        </Theme>
      </MemoryRouter>,
    )
  );
}; */

/* test('Check that search input is changed correctly', async () => {
  const history = createMemoryHistory();
  render(
    <Router history={history}>
      <Theme>
        <App />
      </Theme>
    </Router>,
  );
  const searchLink = screen.getByTestId('navbar-0');
  user.click(searchLink);
  const searchInput = screen.getByTestId('search-input');
  // Simulating an onChange event instead of using typing simulation
  fireEvent.change(searchInput, { target: { value: 'learnprogramming' } });
  expect(searchInput.value).toBe('learnprogramming');
}); */

/* test('Search input value is set to default value', () => {
  const { getByTestId } = renderWithHistory(<SearchPage />, DEFAULT_PATH, DEFAULT_SUBREDDIT);
  const searchInput = getByTestId('search-input');
  expect(searchInput.value).toBe(DEFAULT_SUBREDDIT);
}); */


/* test('Search input value is set to default value', () => {
  const homePage = app;
  const searchInput = homePage.getByTestId('search-input');
  expect(searchInput.value).toBe(DEFAULT_SUBREDDIT);
}); */

/* test('Search input is set to default', () => {
  const homePage = app;
  const searchLink = homePage.getByTestId('navbar-0');
  user.click(searchLink);
  const searchInput = homePage.getByTestId('search-input');
  expect(searchInput.value).toBe(DEFAULT_SUBREDDIT);
}); */
/* test('User can change search input', () => {
  const homePage = renderHomePage();
  const searchLink = homePage.getByTestId('navbar-0');
  user.click(searchLink);
  const searchInput = homePage.getByTestId('search-input');
  // Simulating an onChange event instead of using typing simulation
  fireEvent.change(searchInput, { target: { value: 'learnprogramming' } });
  expect(searchInput.value).toBe('learnprogramming');
});
 */
